#!/usr/bin/env bash
set -euo pipefail

PROXY="http://10.17.89.69:3142/"
WARM_SOURCES="$(mktemp /tmp/acng-warm-sources.XXXXXX)"

cleanup() {
    rm -f "$WARM_SOURCES"
}
trap cleanup EXIT

rewrite_url() {
    local url="$1"

    case "$url" in
        https://downloads.cursor.com/aptrepo/*)
            printf 'http://cursor.cache/%s\n' "${url#https://downloads.cursor.com/aptrepo/}"
            ;;
        https://dl.google.com/linux/chrome/deb/*)
            printf 'http://chrome.cache/%s\n' "${url#https://dl.google.com/linux/chrome/deb/}"
            ;;
        https://deb.nodesource.com/node_23.x/*)
            printf 'http://nodesrc.cache/%s\n' "${url#https://deb.nodesource.com/node_23.x/}"
            ;;
        https://deb.packages.mattermost.com/*)
            printf 'http://matter.cache/%s\n' "${url#https://deb.packages.mattermost.com/}"
            ;;
        https://packages.microsoft.com/repos/code/*)
            printf 'http://mscode.cache/%s\n' "${url#https://packages.microsoft.com/repos/code/}"
            ;;
        https://ppa.launchpad.net/*)
            printf 'http://lp.cache/%s\n' "${url#https://ppa.launchpad.net/}"
            ;;
        https://ppa.launchpadcontent.net/*)
            printf 'http://lp.cache/%s\n' "${url#https://ppa.launchpadcontent.net/}"
            ;;
        *)
            # For http://apt.pop-os.org/... or anything else:
            printf '%s\n' "$url"
            ;;
    esac
}

process_deb822_file() {
    local file="$1"

    while IFS= read -r line || [ -n "$line" ]; do
        # Check if this is a URIs: line
        if [[ "$line" =~ ^([[:space:]]*URIs:[[:space:]]*)(.*)$ ]]; then
            local prefix="${BASH_REMATCH[1]}"
            local uris="${BASH_REMATCH[2]}"
            local rewritten_uris=""
            local first=true
            local changed=false

            # Process each URI (space-separated)
            for uri in $uris; do
                local new_uri
                new_uri=$(rewrite_url "$uri")
                
                if [ "$new_uri" != "$uri" ]; then
                    changed=true
                fi
                
                if [ "$first" = true ]; then
                    rewritten_uris="$new_uri"
                    first=false
                else
                    rewritten_uris="$rewritten_uris $new_uri"
                fi
            done

            if [ "$changed" = true ]; then
                echo "${prefix}${rewritten_uris}"
            else
                echo "$line"
            fi
        else
            # All other lines pass through unchanged
            echo "$line"
        fi
    done < "$file"
}

generate_warm_sources() {
    {
        echo "### Generated for apt-cacher-ng warm run ###"

        # Process old-format .list files
        cat /etc/apt/sources.list /etc/apt/sources.list.d/*.list 2>/dev/null \
        | while read -r line || [ -n "$line" ]; do
            case "$line" in
                deb\ *|deb-src\ *)
                    # handle: deb [opts] URL suite components...
                    # split first token (deb or deb-src)
                    set -- $line
                    local first="$1"
                    shift

                    if [[ "$1" == \[* ]]; then
                        # has options in [ ]
                        local opts="$1"
                        shift
                        local url="$1"
                        shift
                        local rest="$*"
                        local new_url
                        new_url=$(rewrite_url "$url")
                        printf '%s %s %s %s\n' "$first" "$opts" "$new_url" "$rest"
                    else
                        # no [opts]
                        local url="$1"
                        shift
                        local rest="$*"
                        local new_url
                        new_url=$(rewrite_url "$url")
                        printf '%s %s %s\n' "$first" "$new_url" "$rest"
                    fi
                    ;;
                *)
                    # comments / blank lines passthrough
                    echo "$line"
                    ;;
            esac
        done

        # Process new deb822-format .sources files
        for file in /etc/apt/sources.list.d/*.sources; do
            [ -f "$file" ] || continue
            process_deb822_file "$file"
        done
    } >"$WARM_SOURCES"
}

# Ensure curl exists (for the proxy-availability check)
if ! command -v curl >/dev/null 2>&1; then
    sudo apt-get install -y curl
fi

# Only bother with warm-sources if proxy is reachable
if curl -s --connect-timeout 1 "$PROXY" >/dev/null 2>&1; then
    generate_warm_sources

    sudo /usr/bin/apt \
        -o Acquire::http::Proxy="$PROXY" \
        -o Acquire::https::Proxy="$PROXY" \
        -o Acquire::By-Hash=true \
        -o Dir::Etc::sourcelist="$WARM_SOURCES" \
        -o Dir::Etc::sourceparts="-" \
        "$@"
else
    # fall back to normal behavior if proxy is down
    sudo /usr/bin/apt "$@"
fi